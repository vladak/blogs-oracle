<html><body>
<head>
            <title>Netcat as small packet factory | Oracle Czech techie's adventures Blog</title>
<meta name="publish_date" content="2009-09-01 06:17:24">
</head>
                                                                    <p>Recently I needed to test a bug fix in in.iked(1M) (should say <tt>libike.so</tt> with which <tt>in.iked</tt> is linked)<br/>after which the daemon should respond<br/>to IKEv2 requests with Notification message telling the peer to fall back to IKEv1 (previously<br/>it did not respond to IKEv2 packets at all). This can be tested by:</p><ul><li>installing a OS instance which supports IKEv2 and initiating from there</li><li>writing a simple program (C/Perl/etc.) which will construct the UDP payload</li></ul><p>Surely, there should be easier way how to send a UDP paket with arbitrary (in my case ISAKMP) payload.<br/>It turns out this is very easy to do just from command line with nc(1) which is available in OpenSolaris<br/>(install it via '<tt>pkg install SUNWnetcat</tt>'). Let's try to send some garbage first to see if it works:</p><pre>perl -e 'print "&#92;&#92;x41&#92;&#92;x41";' | nc -u rpe-foo.czech 500</pre><p>Yep, tshark(1) (in OpenSolaris shipped by default with <br/><a href="http://www.wireshark.org/">Wireshark</a>) reports an IKE packet, malformed one (which is not surprising):</p><pre>Capturing on eri0<br/>  0.000000 10.18.144.12 -> 10.18.144.11 ISAKMP [Malformed Packet]<br/>0000  00 0a e4 2f 61 eb 00 03 ba 4e 3d 38 08 00 45 00   .../a....N=8..E.<br/>0010  00 1e 26 98 40 00 ff 11 20 fb 0a 12 90 0c 0a 12   ..&.@... .......<br/>0020  90 0b e2 66 01 f4 00 0a 34 57 41 41               ...f....4WAA</pre><p>Our two A's are there just after the UDP header (Ethernet header 14 bytes, IP header 20 bytes, UDP 8 bytes, <br/>in sum 42 bytes and our 2 bytes are just after first 8 bytes on 3rd line).</p><p>With that we can go and construct IKEv1 packet first to see if the daemon will react upon it.<br/>We will need to construct the payload which is a IKEv1 header. IKEv1 is defined in <br/><a href="http://tools.ietf.org/html/rfc2409">RFC 2409</a> (The Internet Key Exchange (IKE)). <br/>IKEv1 uses ISAKMP header definition <br/>so we need to look into <a href="http://tools.ietf.org/html/rfc2408">RFC 2408</a> <br/>(Internet Security Association and Key Management Protocol (ISAKMP)) for the actual <br/>header definition. It's there in section 3.1:</p><pre>                         1                   2                   3<br/>     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1<br/>    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>    !                          Initiator                            !<br/>    !                            Cookie                             !<br/>    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>    !                          Responder                            !<br/>    !                            Cookie                             !<br/>    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>    !  Next Payload ! MjVer ! MnVer ! Exchange Type !     Flags     !<br/>    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>    !                          Message ID                           !<br/>    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>    !                            Length                             !<br/>    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</pre><p>I'd like to construct a packet which resembles first packet sent by IKEv1 Initiator.<br/>So, our packet code (similar to shell code) will look like this (without thinking too<br/>much of what should the values look like):<ul><li>Initiator's cookie, must not be zero<pre>    &#92;&#92;x11&#92;&#92;x22&#92;&#92;x33&#92;&#92;x44&#92;&#92;x55&#92;&#92;x66&#92;&#92;x77&#92;&#92;x88</pre></li><li>Responder's cookie, must be zero in the initial packet from Initiator<pre>    &#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00</pre></li><li>next payload, let's try 0 first<pre>    &#92;&#92;x00</pre></li><li>Major and Minor Version (4 bits each)<pre>    &#92;&#92;x10</pre></li><li>Exchange Type<pre>                            Exchange Type      Value<br/>                         NONE                    0<br/>                         Base                    1<br/>                         Identity Protection     2<br/>                         Authentication Only     3<br/>                         Aggressive              4<br/>                         Informational           5<br/>                         ISAKMP Future Use     6 - 31<br/>                         DOI Specific Use     32 - 239<br/>                         Private Use         240 - 255</pre><br/>   So let's try Base first:<pre>    &#92;&#92;x01</pre></li><li>Flags (Initiator)<pre>    &#92;&#92;x00</pre></li><li>Message ID<pre>    &#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66</pre></li><li>Length<pre>    &#92;&#92;x28</pre></li></ul></p><p>We need to massage our packet code into command line. The code:</p><pre> &#92;&#92;x11&#92;&#92;x22&#92;&#92;x33&#92;&#92;x44&#92;&#92;x55&#92;&#92;x66&#92;&#92;x77&#92;&#92;x88<br/> &#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00<br/> &#92;&#92;x00<br/> &#92;&#92;x10<br/> &#92;&#92;x01<br/> &#92;&#92;x00<br/> &#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66<br/> &#92;&#92;x28</pre><p>We want source port to be 500 as well because of section 2.5.1 in RFC 2408 so use the -p option <br/>(this requires the <tt>net_privaddr</tt> privilege so either become root or use pfexec(1)).<br/>Also, we do not need to wait for the response so use -w option:</p><pre>perl -e 'print "&#92;&#92;x11&#92;&#92;x22&#92;&#92;x33&#92;&#92;x44&#92;&#92;x55&#92;&#92;x66&#92;&#92;x77&#92;&#92;x88&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x10&#92;&#92;x01&#92;&#92;x00&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x28";' &#92;&#92;<br/>    | nc -w 1 -p 500 -u rpe-foo.czech 500</pre><p>The packet was received but there was no reply and tshark still considers this as Malformed Packet.<br/>Let's check the header again - oh yeah, the Length field has 4 bytes, not just one. Let's try again:</p><pre>perl -e 'print "&#92;&#92;x11&#92;&#92;x22&#92;&#92;x33&#92;&#92;x44&#92;&#92;x55&#92;&#92;x66&#92;&#92;x77&#92;&#92;x88&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x10&#92;&#92;x01&#92;&#92;x00&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x28&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00";' &#92;&#92;<br/>    | nc -w 1 -p 500 -u rpe-foo.czech 500</pre><p>Okay, this is our Base exchange but still not response:</p><pre>294.029154 10.18.144.12 -> 10.18.144.11 ISAKMP Base<br/>0000  00 0a e4 2f 61 eb 00 03 ba 4e 3d 38 08 00 45 00   .../a....N=8..E.<br/>0010  00 38 26 a7 40 00 ff 11 20 d2 0a 12 90 0c 0a 12   .8&.@... .......<br/>0020  90 0b 01 f4 01 f4 00 24 34 71 11 22 33 44 55 66   .......&#36;4q."3DUf<br/>0030  77 88 00 00 00 00 00 00 00 00 00 10 01 00 66 66   w.............ff<br/>0040  66 66 28 00 00 00                    </pre><p>Let's try something more provocative and set the Exchange type to Identity protection:</p><pre>perl -e 'print "&#92;&#92;x11&#92;&#92;x22&#92;&#92;x33&#92;&#92;x44&#92;&#92;x55&#92;&#92;x66&#92;&#92;x77&#92;&#92;x88&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x10&#92;&#92;x02&#92;&#92;x00&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x28&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00";' &#92;&#92;<br/>    | nc -w 1 -p 500 -u rpe-foo.czech 500</pre><p>Oh yeah, this finally deserved a response:</p><pre>383.050874 10.18.144.12 -> 10.18.144.11 ISAKMP Identity Protection (Main Mode)<br/>0000  00 0a e4 2f 61 eb 00 03 ba 4e 3d 38 08 00 45 00   .../a....N=8..E.<br/>0010  00 38 26 a8 40 00 ff 11 20 d1 0a 12 90 0c 0a 12   .8&.@... .......<br/>0020  90 0b 01 f4 01 f4 00 24 34 71 11 22 33 44 55 66   .......&#36;4q."3DUf<br/>0030  77 88 00 00 00 00 00 00 00 00 00 10 02 00 66 66   w.............ff<br/>0040  66 66 28 00 00 00                                 ff(...<br/>383.051672 10.18.144.11 -> 10.18.144.12 ISAKMP Informational<br/>0000  00 03 ba 4e 3d 38 00 0a e4 2f 61 eb 08 00 45 00   ...N=8.../a...E.<br/>0010  00 99 d3 8b 40 00 ff 11 73 8c 0a 12 90 0b 0a 12   ....@...s.......<br/>0020  90 0c 01 f4 01 f4 00 85 ed 05 11 22 33 44 55 66   ..........."3DUf<br/>0030  77 88 85 75 8e 0f fa a5 5d de 0b 10 05 00 69 a5   w..u....].....i.<br/>0040  63 e4 00 00 00 7d 00 00 00 61 00 00 00 01 01 10   c....}...a......<br/>0050  00 1e 11 22 33 44 55 66 77 88 85 75 8e 0f fa a5   ..."3DUfw..u....<br/>0060  5d de 80 0c 00 01 00 06 00 39 55 44 50 20 50 61   ]........9UDP Pa<br/>0070  63 6b 65 74 20 64 6f 65 73 20 6e 6f 74 20 63 6f   cket does not co<br/>0080  6e 74 61 69 6e 20 65 6e 6f 75 67 68 20 64 61 74   ntain enough dat<br/>0090  61 20 66 6f 72 20 49 53 41 4b 4d 50 20 70 61 63   a for ISAKMP pac<br/>00a0  6b 65 74 80 08 00 00                              ket....</pre><p>Now that we proved to ourselves that we can construct semi-valid packet it's time to try IKEv2.<br/>IKEv2 header is defined in <a href="http://tools.ietf.org/html/rfc4306">RFC 4306</a>, section 3.1:</p><pre>                           1                   2                   3<br/>       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1<br/>      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>      !                       IKE_SA Initiator's SPI                  !<br/>      !                                                               !<br/>      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>      !                       IKE_SA Responder's SPI                  !<br/>      !                                                               !<br/>      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>      !  Next Payload ! MjVer ! MnVer ! Exchange Type !     Flags     !<br/>      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>      !                          Message ID                           !<br/>      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br/>      !                            Length                             !<br/>      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</pre><p>On a first sight, it looks the same (for backward compatibility). However, some of the values are different. <br/>For IKE header, the main differences are in the Exchange Type and Flags:</p><pre>                       Exchange Type            Value<br/>                       RESERVED                 0-33<br/>                       IKE_SA_INIT              34<br/>                       IKE_AUTH                 35<br/>                       CREATE_CHILD_SA          36<br/>                       INFORMATIONAL            37<br/>                       RESERVED TO IANA         38-239<br/>                       Reserved for private use 240-255</pre><p>IKE_SA_INIT is our guy ('<tt>echo 0t34=x | mdb</tt>' produces 0x22).</p><p>The flags are now used to indicate the exchange. Set 3rd bit to say we are the Initiator.<br/>We will retain the source port even though IKEv2 supports ports other than 500 and 4500 <br/>because we're dealing with IKEv1 implementation.<br/>Now slightly change our packet code (don't forget to change the Version field to 2.0):</p><pre>perl -e 'print "&#92;&#92;x11&#92;&#92;x22&#92;&#92;x33&#92;&#92;x44&#92;&#92;x55&#92;&#92;x66&#92;&#92;x77&#92;&#92;x88&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x20&#92;&#92;x22&#92;&#92;x08&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x28&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00";' &#92;&#92;<br/>    | nc -w 1 -p 500 -u rpe-foo.czech 500</pre><p>And we got a nice response (since the responder runs recent version <tt>libike.so</tt>):</p><pre>1013.190867 10.18.144.12 -> 10.18.144.11 ISAKMP IKE_SA_INIT<br/>0000  00 0a e4 2f 61 eb 00 03 ba 4e 3d 38 08 00 45 00   .../a....N=8..E.<br/>0010  00 38 26 aa 40 00 ff 11 20 cf 0a 12 90 0c 0a 12   .8&.@... .......<br/>0020  90 0b 01 f4 01 f4 00 24 34 71 11 22 33 44 55 66   .......&#36;4q."3DUf<br/>0030  77 88 00 00 00 00 00 00 00 00 00 20 22 08 66 66   w.......... ".ff<br/>0040  66 66 28 00 00 00                                 ff(...<br/>1013.192005 10.18.144.11 -> 10.18.144.12 ISAKMP Informational<br/>0000  00 03 ba 4e 3d 38 00 0a e4 2f 61 eb 08 00 45 00   ...N=8.../a...E.<br/>0010  00 83 d3 8d 40 00 ff 11 73 a0 0a 12 90 0b 0a 12   ....@...s.......<br/>0020  90 0c 01 f4 01 f4 00 6f 66 da 11 22 33 44 55 66   .......of.."3DUf<br/>0030  77 88 5c 36 e3 75 a2 7b 8e fe 0b 10 05 00 87 03   w.&#92;&#92;6.u.{........<br/>0040  0c f5 00 00 00 67 00 00 00 4b 00 00 00 01 01 10   .....g...K......<br/>0050  00 05 11 22 33 44 55 66 77 88 5c 36 e3 75 a2 7b   ..."3DUfw.&#92;&#92;6.u.{<br/>0060  8e fe 80 0c 00 01 00 06 00 23 49 6e 76 61 6c 69   .........#Invali<br/>0070  64 20 49 53 41 4b 4d 50 20 6d 61 6a 6f 72 20 76   d ISAKMP major v<br/>0080  65 72 73 69 6f 6e 20 6e 75 6d 62 65 72 80 08 00   ersion number...<br/>0090  00   </pre><p>The only thing which is not nice is our terminal since nc(1) dumped the binary packet<br/>to it. Let's try again with some post-processing:</p><pre># perl -e 'print "&#92;&#92;x11&#92;&#92;x22&#92;&#92;x33&#92;&#92;x44&#92;&#92;x55&#92;&#92;x66&#92;&#92;x77&#92;&#92;x88&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00&#92;&#92;x20&#92;&#92;x22&#92;&#92;x08&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x66&#92;&#92;x28&#92;&#92;x00&#92;&#92;x00&#92;&#92;x00";'     <br/>| nc -w 1 -p 500 -u rpe-foo.czech 500 | od -c<br/>0000000 021   "   3   D   U   f   w 210 237   y 254 264 351 333 007 344<br/>0000020 013 020 005  &#92;&#92;0   [ 251 244   j  &#92;&#92;0  &#92;&#92;0  &#92;&#92;0   g  &#92;&#92;0  &#92;&#92;0  &#92;&#92;0   K<br/>0000040  &#92;&#92;0  &#92;&#92;0  &#92;&#92;0 001 001 020  &#92;&#92;0 005 021   "   3   D   U   f   w 210<br/>0000060 237   y 254 264 351 333 007 344 200  &#92;&#92;f  &#92;&#92;0 001  &#92;&#92;0 006  &#92;&#92;0   #<br/>0000100   I   n   v   a   l   i   d       I   S   A   K   M   P       m<br/>0000120   a   j   o   r       v   e   r   s   i   o   n       n   u   m<br/>0000140   b   e   r 200  &#92;&#92;b  &#92;&#92;0  &#92;&#92;0<br/>0000147</pre><p>The fix is obviously in place.</p>
</body></html>
