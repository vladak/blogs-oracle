<html><body>
<head>
            <title>Automatic webrev upload | Oracle Czech techie's adventures Blog</title>
<meta name="publish_date" content="2008-11-07 03:50:45">
</head>
                                                                    <p>I will start this one a little bit generically..</p><p>Part of standard <a href="http://opensolaris.org/">OpenSolaris</a>/<a href="http://www.sun.com/software/solaris/">Solaris</a><br/>development process is <a href="http://opensolaris.org/os/community/on/devref_toc/devref_6/#6_1_code_review_process">code review</a>. <br/>To facilitate a review, a so-called <i>webrev</i> is needed. A webrev is set of HTML/text/PDF pages and documents which<br/>display all the changes between local repository containing the changes and its parent repository. To produce a webrev,<br/>simply switch to a repository and run the <tt>webrev</tt> script (it is part of <tt>SUNWonbld</tt> package, which can be downloaded<br/>from <a href="http://dlc.sun.com/osol/on/downloads/current/">OpenSolaris download center</a>.):</p><pre>&#36; cd /local/Source/bugfix-314159.onnv<br/>&#36; webrev</pre><p>Assuming <tt>/opt/onbld/bin</tt> is present in your <tt>PATH</tt> a webrev will be generated under <br/><tt>/local/Source/bugfix-314159.onnv/webrev/</tt> directory.</p><p>For OpenSolaris changes, the webrev is usually uploaded to <a href="http://cr.opensolaris.org/">cr.opensolaris.org</a><br/>(every OpenSolaris member has an account automatically created for him) which serves it under <tt>http://cr.opensolaris.org/~OSol_username/</tt><br/>(where <tt>OSol_username</tt> is your OpenSolaris username) and a request for review with a link to the webrev is sent <br/>to one of the mailing lists relevant to the change.<br/><br/><br/><a href="http://blogs.sun.com/dp/">Dan Price</a> has written a script which produces<br/>RSS feed out of recently uploaded webrevs which is pretty handy substitute for feeds from news/headlines/magazines :)</p><p>For a long time I was basically doing the following:</p><pre>&#36; cd /local/Source/bugfix-foo.onnv && webrev<br/>&#36; scp -r webrev cr.opensolaris.org:bugfix-foo.onnv</pre><p>This had two flaws: first it was slow (because of <a href="http://blogs.sun.com/janp/entry/how_the_scp_protocol_works">rcp protocol <br/>over SSH channel</a>) and second I had to delete it via separate command (use sftp(1) and rename the old webrev to <tt>.trash</tt><br/>directory) before uploading new version of the webrev (otherwise couple of permissions errors would follow).</p><p>To solve the first problem, <tt>rsync</tt> (with SSH transport) can be used which makes the upload nearly instantaneous.<br/>Second problem can be worked around by using incremental webrevs. Still, this does not seem good enough for code reviews<br/>with many iterations.</p><p>So, the change made in CR 6752000 introduces the following command line options for automatic webrev upload:</p><ul><li><tt>-U</tt> uploads the webrev</li><li><tt>-n</tt> suppresses webrev generation</li><li><tt>-t</tt> allows to specify custom upload target</li></ul><p><a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/tools/scripts/webrev.1">webrev.1</a> man page has been<br/>updated to explain the usage. For common OpenSolaris code reviews the usage will probably mostly look like this:</p><pre>&#36; webrev -O -U</pre><p>This will upload the webrev to cr.opensolaris.org under directory named according to local repository name. Further invocations<br/>will replace the remote webrev with fresh version.<br/><br/><br/>But it is possible to get more advanced. After the initial webrev is posted, an incremental webrev can be both generated and posted.<br/>Assuming you're switched to the repository (via <tt>bldenv</tt>) and we're dealing with 4th round of code review the following<br/>command will perform the task:</p><pre>webrev_name=`basename &#36;CODEMGR_WS`<br/>webrev -O -U -o &#36;CODEMGR_WS/&#36;{webrev_name}.rd4 &#92;&#92;<br/>    -p &#36;CODEMGR_WS/&#36;{webrev_name}.rd3</pre><p>The above commands hide maybe not-so-obvious behavior so I'll try to explain it in the table:</p><pre>+---------------------------+------------------------+-----------------------------------------------------+<br/>| command                   | local webrev directory | remote webrev directory                             |<br/>+---------------------------+------------------------+-----------------------------------------------------+<br/>| webrev -O -U              | &#36;CODEMGR_WS/webrev/    | cr.opensolaris.org/~OSOLuser/`basename &#36;CODEMGR_WS` |<br/>+---------------------------+------------------------+-----------------------------------------------------+<br/>| webrev -O -o &#92;&#92;            | &#36;CODEMGR_WS/my_webrev/ | cr.opensolaris.org/~OSOLuser/my_webrev              |<br/>|   &#36;CODEMGR_WS/my_webrev   |                        |                                                     |<br/>+---------------------------+------------------------+-----------------------------------------------------+<br/>| webrev -O &#92;&#92;               | &#36;CODEMGR_WS/fix.rd2/   | cr.opensolaris.org/~OSOLuser/fix.rd2                |<br/>|  -p &#36;CODEMGR_WS/fix.rd1 &#92;&#92; |                        |                                                     |<br/>|  -o &#36;CODEMGR_WS/fix.rd2   |                        |                                                     |<br/>+---------------------------+------------------------+-----------------------------------------------------+</pre><p>Basically, without the <tt>-o</tt> flag <tt>webrev</tt> will generate the webrev to local directory named 'webrev'<br/>but it will upload it to the directory named after basename of local repository.<br/>With the -o flag webrev will use the name of root directory of the repository it is called from for both local and remote<br/>storage. This is done to keep the default behavior of generating local webrev to directory <br/>named 'webrev'. At the same time, uploading different webrevs to the same remote directory named 'webrev' does not make sense.</p><p>NOTE: This behavior is also valid in the case when not enclosed in a repository via <tt>ws</tt> or <tt>bldenv</tt>,<br/>I have just used <tt>&#36;CODEMGR_WS</tt> to express root directory of a workspace/repository.</p><p>Also, now it is possible to call webrev from within Cadmium Mercurial plugin, so all webrev commands can be prefixed with hg.</p></p><br/>All in all, it was fun dealing with webrevs of <tt>webrev</tt>. I am looking forward to more entries in the RSS feed :)</p><p>NOTE: It will take some time before the changes appear in <tt>SUNWonbld</tt> packages offered by the download center<br/>so it's better to update the sources from the <tt>ssh://anon@hg.opensolaris.org/hg/onnv/onnv-gate</tt> repository<br/>and build and upgrade the <tt>SUNWonbld</tt> package from there.</p>
</body></html>
