<html><body>
<head>
            <title>Grepping dtrace logs | Oracle Czech techie's adventures Blog</title>
<meta name="publish_date" content="2008-02-11 09:24:39">
</head>
                                                                    <p>I have been working on a tough bug for some non-trivial time. The bug is a <br/>combination of race condition and data consistency issues. To debug this I am<br/>using multi-threaded apache process and dtrace heavily. The logs produced by<br/>dtrace are huge and contain mostly dumps of internal data structures.</p><p>The excerpt from such log looks e.g. like this:</p><pre>  1  50244       pk11_return_session:return       128   8155.698<br/>  1  50223            pk11_RSA_verify:entry       128   8155.7069<br/>  1  50224           pk11_get_session:entry       128   8155.7199<br/>  1  50234          pk11_get_session:return       128   8155.7266<br/>PK11_SESSION:<br/>  pid = 1802<br/>  session handle = 0x00273998<br/>  rsa_pub_key handle -> 0x00184e70<br/>  rsa_priv_key handle -> 0x00274428<br/>  rsa_pub = 0x00186248<br/>  rsa_priv = 0x001865f8<br/>  1  50224           pk11_get_session:entry       128   8155.7199<br/>  1  50244       pk11_return_session:return       128   8155.698</pre><p><i>Side note</i>: This is post-processed log (probe together with their bodies are <br/>timestamp sorted, time stamps are converted<br/>to miliseconds - see <a href="http://blogs.sun.com/vlad/entry/coloring_dtrace_output">Coloring dtrace output entry</a> for details and scripts).</p><p>Increasingly, I was asking myself questions which resembled this one: "when function <br/><tt>foo()</tt> was called with data which contained value <tt>bar</tt> ?"</p><p>This quickly lead to a script which does the tedious job for me.<br/><tt>dtrace-grep.pl</tt> accepts 2 or 3 parameters. First 2 are probe pattern and<br/>data pattern, respectively. Third, which is optional, is input file (if not supplied, <br/><tt>stdin</tt> will be used). Example of use on the above pasted file looks like this:</p><pre>~/bin&#36; ./dtrace-grep.pl pk11_get_session 0x00186248 /tmp/test<br/>  1  50234          pk11_get_session:return       128   8155.7266<br/>PK11_SESSION:<br/>  pid = 1802<br/>  session handle = 0x00273998<br/>  rsa_pub_key handle -> 0x00184e70<br/>  rsa_priv_key handle -> 0x00274428<br/>  rsa_pub = 0x00186248<br/>  rsa_priv = 0x001865f8<br/>~/bin&#36; </pre><p>Now I have to get back to work, to do some more <a href="http://en.wikipedia.org/wiki/Pattern_Recognition_%28novel%29">pattern matching</a>.<br/>Oh, and the script is <a href="http://blogs.sun.com/vlad/resource/dtrace-grep.pl">here</a>.</p>
</body></html>
