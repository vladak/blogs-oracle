<html><body>
<head>
            <title>Coloring dtrace output | Oracle Czech techie's adventures Blog</title>
<meta name="publish_date" content="2007-06-14 03:05:12">
</head>
                                                                    <p>Currently I am working on a subtle bug in <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/uts/common/inet/kssl/">KSSL</a>. (SSL kernel proxy) In order to diagnose the root cause of the bug I use set of <a href="http://opensolaris.org/os/community/dtrace/">dtrace</a><br/>scripts to gather data in various probes. One of the dtrace scripts I am using looks like this:</p><pre>#!/usr/sbin/dtrace -Cs<br/>/&#92;*<br/>  trace mbuf which caused activation of <br/>  kssl-i-kssl_handle_any_record_recszerr probe<br/>  NOTE: this presumes that every mblk seen by TCP/KSSL<br/>        is resonably sized (cca 100 bytes)<br/> &#92;*/<br/>/&#92;* how many bytes from a mblk to dump &#92;*/<br/>#define DUMP_SIZE       48<br/>/&#92;* <br/>  generic kssl mblk dump probe <br/>  (covers both input path and special cases)<br/> &#92;*/<br/>sdt:::kssl_mblk-&#92;*<br/>{<br/>  trace(timestamp);<br/>  printf("&#92;&#92;nmblk size = %d",<br/>      ((mblk_t &#92;*)arg0)->b_wptr - ((mblk_t &#92;*)arg0)->b_rptr);<br/>  tracemem(((mblk_t &#92;*)arg0)->b_rptr, DUMP_SIZE);<br/>  tracemem(((mblk_t &#92;*)arg0)->b_wptr - DUMP_SIZE, DUMP_SIZE);<br/>}</pre><p>The scripts usually collect big chunks of data from the various <br/><a href="http://docs.sun.com/app/docs/doc/817-6223/6mlkidlkd?a=view">SDT probes</a> <br/>I have put into kssl kernel module. After the data<br/>are collected I usually spend big chunks of time sifting though it.<br/>At one point of time I have got a suspicion that the problem is actually<br/>a race condition of sorts. In order to shed some light on what's going<br/>on I have used less(1) which provides highlighting of data when searching.<br/>While this is sufficient when searching for a single pattern, it does not scale<br/>when more patterns are used. This is when I got the idea to color the<br/>output from dtrace scripts to see the correlations (or lack of them) of <br/>the events with a simple Perl script. Example of the output colored by the script:</p><br/><img src="dtrace_coloring_data.png"<br/>alt="colored dtrace output (data)"><p>This looks slightly more useful than plain black output in terminal but even <br/>with 19" display the big picture is missing.<br/>So, I have changed the dtrace-coloring script to be able to strip the data parts <br/>for probes and print just the headers:</p><br/><img src="dtrace_color_headers.png" <br/>alt="colored dtrace output (headers)"><p>This is done via '-n' command line option. (the default is to print everything.)<br/>The output containing just the colored headers is especially nice for tracking<br/>down race conditions and other time-sensitive misbehaviors.<br/>You can download the script for dtrace log coloring here:<br/><a href="http://blogs.sun.com/vlad/resource/dtrace-coloring.pl">dtrace-coloring.pl</a></p><p>The colors can be assigned to regular expressions in the hash 'coloring' in<br/>the script itself. For the example above I have used the following assignments:</p><pre>my %coloring = (<br/>  '.&#92;*kssl_mblk-i-handle_record_cycle.&#92;*' => '4b6983',    # dark blue<br/>  '.&#92;*kssl_mblk-enqueue_mp.&#92;*'    => '6b7f0d',    # dark green<br/>  '.&#92;*kssl_mblk-getnextrecord_retmp.&#92;*'   => 'a11c10',    # dark red<br/>);</pre><p>In the outputs above you might have noticed that a timestamp is printed when a probe fires. <br/>This is useful for pre-processing of the log file.<br/>dtrace(1) <br/>(or <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libdtrace/">libdtrace</a> to be more precise) does not sort events as they come<br/>from the kernel. (see <a href="http://bugs.opensolaris.org/view_bug.do?bug_id=6496550">CR 6496550</a> for more details) <br/>In cases when hunting down a race condition on multiprocessor machine having the output sorted<br/>is crucial. So in order to get consistent<br/>image suitable for race condition investigation a sort script is needed. You might<br/>use a <a href="http://blogs.sun.com/vlad/resource/sort-dtrace.pl">crude script of mine</a> or you can write yours :)</p><p><a href="http://technorati.com/claim/5suvvphijf" rel="me">Technorati Profile</a></p>
</body></html>
