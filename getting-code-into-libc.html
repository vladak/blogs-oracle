<html><body>
<head>
            <title>Getting code into libc | Oracle Czech techie's adventures Blog</title>
<meta name="publish_date" content="2007-08-28 04:30:00">
</head>
                                                                    <p>In my previous entry about <a href="http://blogs.sun.com/vlad/entry/closing_bsd_compatibility_gap">BSD compatibility gap closure process</a> I have promised to provide a guide on how to get new code into <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libc/">libc</a>.<br/>I will use changes done via <a href="http://bugs.opensolaris.org/view_bug.do?bug_id=6495220">CR 6495220</a> to illustrate the process with examples.</p><p>Process related and technical changes which are usually needed:</p><ul><li>get <a href="http://www.opensolaris.org/os/community/arc/">PSARC</a> case done<br/></li><li><br/>  File a CR to create a manual page according to the man page draft supplied with <br/>  the PSARC case. You will probably need to go through the functions being added <br/>  and assign them MT-Level according to attributes(5) man page (if this was not done<br/>  prior to filing the PSARC case).</li><li>actually add the code into libc<br/><br/>  This includes moving/introducing files from the <a href="http://www.opensolaris.org/os/community/tools/scm/">SCM</a> point of view and doing <br/>  necessary changes to the Makefiles.<br/><br/>  In terms of symbols, the functions need to be actually delivered twice. <br/>  Once as underscored (strong) symbol and second as <a href="http://docs.sun.com/app/docs/doc/819-0690/6n33n7f57?l=en&a=view&q=weak+symbol">WEAK alias</a> to the strong symbol. This allows libraries use their own private implementation <br/>  of the functions. (This is because the weak symbol is silently overridden by the private symbol in <a href="http://docs.sun.com/app/docs/doc/819-0690/6n33n7f57?l=en&a=view&q=weak+symbol">runtime linker</a>)</li><li>add entries to <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/common/inc/c_synonyms.h">c_synonyms.h</a> and <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libc/inc/synonyms.h">synonyms.h</a><br/><tt>synonyms.h</tt> is used in libc for symbol alias contruction (see above). <tt>c_synonyms.h</tt> provides access to underscored symbols for other (non-libc) libraries. This provides a way how to call the underscored symbols directly without risking namespace clashes/pollution.<br/><br/>  This step is actually needed to be used in conjunction with the previous step. nm(1) can be used to check this worked as expected:<pre>&#36; nm -x /usr/lib/libc.so.1 | grep '|_&#92;&#92;?err&#36;'<br/>[5783] |0x00049c40|0x00000030|FUNC |GLOB |0  |13 |_err<br/>[6552] |0x00049c40|0x00000030|FUNC |WEAK |0  |13 |err</pre></li><li>Do the necessary packaging changes<br/><br/>  If you're adding new header file change <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/pkgdefs/SUNWhea/">SUNWhea</a>'s <tt>prototype_&#92;*</tt> files (most probably just <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/pkgdefs/SUNWhea/prototype_com">prototype_com</a>)<br/><br/>  If the file was previously installed into proto area during build it needs to be removed<br/>  from the exception files (for <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/pkgdefs/etc/exception_list_i386">i386</a> and <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/pkgdefs/etc/exception_list_sparc">sparc</a>).</li><li>modify <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libc/port/mapfile-vers">lib's mapfile</a><br/><br/>  This is needed for the symbols to become visible and versioned. Public symbols belong to the latest <tt>SUNW</tt> section. After you have compiled the changes you can check this via command similar to the following:<pre>pvs -dsv -N SUNW_1.23 /usr/lib/libc.so.1 &#92;&#92;<br/>  | sed -n '1,/SUNW.&#92;*:/p' | egrep '((v?errx?)|(v?warnx?));'<br/>              vwarnx;<br/>              ...</pre><br/>  If you're adding private (underscored) symbols do not forget to add them to the <tt>SUNWprivate</tt> section. This is usually the case because the strong symbols<br/>  are accompanied by weak symbols. Weak symbols go to the global part of the most recent<tt>SUNW</tt> section and strong symbols go to global part of <tt>SUNWprivate</tt> section.</li><li>update libc's <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libc/port/llib-lc">lint library</a></br><br/>  If you are adding private symbols then add them as well. See the entries <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libc/port/llib-lc#379">_vwarnfp</a> et al. for example.<br/><br/>  After you're done it's time to run nightly with lint checks and fix the noise. (see below)</li><li>Add per-symbol filters<br/><br/>  If you are moving stuff from a library to libc you will probably want to preserve the existing interfaces. To accomplish this <a href"http://blogs.sun.com/rie/entry/shared_object_filters">per-symbol filters</a> can be added to the library you're moving from. So, if symbol <tt>foo</tt> is moved from <tt>libbar</tt> to <tt>libc</tt> then change the line in the global section of <tt>libbar</tt>'s mapfile to look like this:<pre>foo = FUNCTION FILTER libc.so.1;</pre><br/>  This was done with the <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libc/port/gen/err.c#127">&#92;*fp functions</a> in <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libipsecutil/common/mapfile-vers#97">libipsecutils' mapfile</a>. The specialty in that case was that the &#92;*fp functions were renamed to underscored variants while moving them via redefines in <a href="http://src.opensolaris.org/source/xref/onnv/onnv-gate/usr/src/lib/libipsecutil/common/errfp.h">errfp.h</a>.</li><li>Fix build/lint noise introduced by the changes<br/><br/>  There could be the following noises:<ul><li>build noise<br/><br/>    Can be caused by symbol type clash (there is symbol of the same name defined in<br/>    libc as FUNC and in &#36;SRC/cmd as OBJT) which is not harmful because ld(1) will<br/>    do due diligence and prefer the non-libc symbol. This can be fixed by <a href="http://src.opensolaris.org/source/diff/onnv/onnv-gate/usr/src/cmd/ypcmd/stdhosts.c?r2=4891&r1=2572">renaming the<br/>    local symbol</a>. There could also be #define clash caused by inclusion <br/>    of <tt>c_synonyms.h</tt>. Fixed via <a href="http://src.opensolaris.org/source/diff/onnv/onnv-gate/usr/src/lib/libnsl/nsl/_data2.c?r2=4891&r1=0">renaming</a> as well.</li><li>lint noise<br/><br/>    In the 3rd pass of the lint checks an inconsistency in function declarations can be<br/>    found such as this:<pre>/builds/.../usr/include/err.h", line 43: warning: function argument declared<br/>inconsistently: warn(arg 1) in utils.c(62) char &#92;* and llib-lc:err.h(43) const char &#92;*<br/>(E_INCONS_ARG_DECL2)</pre><br/>    The problem with this output is that there are <a href="http://src.opensolaris.org/source/search?q=&defs=&refs=&path=utils.c&hist=&project=%2Fonnv">cca 23 files named utils.c</a> in ONNV. CR 6585621 is waiting someone to provide remedy for that via adding -F flag to <tt>LINTFLAGS</tt> in &#36;SRC/lib and &#36;SRC/cmd.<br/><br/>    After the right file(s) are found the fix is usually renaming again. Where <br/>    the renaming is not possible <tt>-erroff=E_FUNC_DECL_VAR_ARG2</tt> can be passed<br/>    to lint(1).</li></ul></li><li>Make sure there are not duplicate symbols in libc after the changes<br/><br/>  This is necessary because it might confuse debugging tools (<a href="http://opensolaris.org/os/community/mdb/">mdb</a>, <a href="http://opensolaris.org/os/community/dtrace/">dtrace</a>).<br/>  For err/warn stuff there was one such occurence:<pre>[6583] | 301316| 37|FUNC |GLOB |0 |13 |_warnx<br/>[1925] | 320000| 96|FUNC |LOCL |0 |13 |_warnx</pre><br/>  This can be usually solved by <a href="http://src.opensolaris.org/source/diff/onnv/onnv-gate/usr/src/lib/libc/port/gen/getopt_long.c?r2=4891&r1=420">renaming the local variant</a>.</li><li>Test thoroughly<ul><li>test with different compilers<br/><br/>     SunStudio does different things than gcc so it is good idea to test the code with both.</li><li>Try to compile different consolidations (e.g. Companion CD, SFW) on top of the <br/>     changes. For err/warn project a bug was filed to get RPM build fixed.</li><li>Test if the WEAK symbols actually work</br></li><li>Test the programs in ONNV affected by the changes<br/><br/>     e.g. the programs which needed to be modified because of the build/lint noise.</li></ul></li><li>Produce annotated putback list explaining the changes<br/><br/>  This is handy for a <a href="http://opensolaris.org/os/community/on/crt/">CRT</a> advocate and saves time.</li><li>If the change requires some sort of action from fellow gatelings, send a heads-up, e.g. like  <a href="http://www.opensolaris.org/os/community/on/flag-days/pages/2007082002/">heads-up for err/warn</a>.</li><li>If you are actually adding code to libc (this includes moving code from other libraries to libc) send an e-mail similar to the heads-up e-mail to opensolaris-code mailing list, e.g. like <a href="http://www.opensolaris.org/jive/thread.jspa?threadID=40653&tstart=0">this message about err/warn</a>.</li></ul>
</body></html>
